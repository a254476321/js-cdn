let c2s=689,s2c=690;function encode(b){let c=[];for(let a in b){c.push(encodeValue(a)+"@="+encodeValue(b[a])+"/")}return toBuffer(encodeRaw(c.join("")))}function encodeRaw(a){let b=putUint(9+a.length,4);return b.concat(b,putUint(c2s,2),[0,0],putString(a),[0])}function encodeValue(a){return a=a.toString().replace("@","@A").replace("/","@S"),unescape(encodeURIComponent(a))}function decode(f){let b=decodeRaw(f);if(b.length===0){return{}}let a=string(b).split("/"),d={},e;for(let c=0,g=a.length-1;c<g;++c){e=a[c].split("@=");d[decodeValue(e[0])]=decodeValue(e[1])}return d}function decodeRaw(c){if(c.length<13){return[]}let b=uint(c.slice(0,4)),a=uint(c.slice(4,8));return b!==a||uint(c.slice(8,10))!==s2c||uint(c.slice(10,11))!==0||uint(c.slice(11,12))!==0?[]:c.slice(12,b+3)}function decodeValue(a){a=a.toString().replace("@A","@").replace("@S","/");try{return decodeURIComponent(escape(a))}catch(b){return"**解码失败**"}}function toBuffer(a){let d=new ArrayBuffer(a.length),c=new DataView(d);for(let b=0,e=a.length;b<e;++b){c.setUint8(b,a[b])}return d}function fromBuffer(d){let a=[],c=new DataView(d);for(let b=0,e=d.byteLength;b<e;++b){a[b]=c.getUint8(b)}return a}function putUint(b,a){let d=[];for(let c=0;c<a;++c){d[c]=(b>>(c<<3))&255}return d}function uint(a){let c=0;for(let b=0,d=a.length;b<d;++b){c|=a[b]<<(b<<3)}return c}function putString(a){let c=[];for(let b=0,d=a.length;b<d;++b){c[b]=a.charCodeAt(b)}return c}function string(a){let c="";for(let b=0,d=a.length;b<d;++b){c+=String.fromCharCode(a[b])}return c}function start(){ws=new WebSocket("wss://danmuproxy.douyu.com:8501/");ws.onopen=()=>{console.log("房间号："+R+"\n弹幕等级："+ML);ws.send(encode({"type":"loginreq","roomid":R}));ws.send(encode({"type":"joingroup","rid":R,"gid":"-9999"}));ws.send(encode({"type":"mrkl"}));alive=setInterval(()=>{ws.send(encode({"type":"mrkl"}))},30000)};ws.onclose=()=>{close();console.log("停止")};ws.onerror=a=>{close();console.error(a)};ws.onmessage=b=>{let a=new FileReader;a.readAsArrayBuffer(b.data);a.onload=()=>{let d=fromBuffer(a.result),c;for(let e=0,f=d.length;e<f;){c=uint(d.slice(e,e+4)),data=decode(d.slice(e,e+4+c));handle(data);e+=c+4}}}}function close(){clearInterval(alive);if(ws){ws.send(encode({"type":"logout"}));ws.close()}}function handle(a){if("chatmsg"==a.type&&parseInt(a.level)>=ML){player.insert({value:a.txt,opacity:0.9,fontWeight:"bold"})}};