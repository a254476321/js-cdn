let c2s=689,s2c=690;function encode(b){let c="";for(let a in b){c+=encodeValue(a)+"@="+encodeValue(b[a])+"/"}return new Uint8Array(encodeRaw(c)).buffer}function encodeRaw(a){let b=putUint(9+a.length,4);return b.concat(b,putUint(c2s,2),0,0,putString(a),0)}function encodeValue(a){return a=a.toString().replace("@","@A").replace("/","@S"),unescape(encodeURIComponent(a))}function decode(f){let b=decodeRaw(f);if(b.length==0){return{}}let a=String.fromCharCode(...b).split("/"),d={},e;for(let c=0,g=a.length-1;c<g;++c){e=a[c].split("@=");d[decodeValue(e[0])]=decodeValue(e[1])}return d}function decodeRaw(a){if(a.length<13){return[]}return(a[0]^a[4]|a[1]^a[5]|a[2]^a[6]|a[3]^a[7])!=0||(a[9]<<8|a[8])!=s2c||(a[10]|a[11])!=0?[]:a.slice(12,uint(a.slice(0,4))+3)}function decodeValue(a){a=a.toString().replace("@A","@").replace("@S","/");try{return decodeURIComponent(escape(a))}catch(b){return"**解码失败**"}}function putUint(b,a){let d=[];for(let c=0;c<a;++c){d[c]=b&255;b>>=8}return d}function uint(a){let c=0;for(let b=a.length-1;b>=0;--b){c=c<<8|a[b]}return c}function putString(a){let c=[];for(let b=0,d=a.length;b<d;++b){c[b]=a.charCodeAt(b)}return c}function start(){ws=new WebSocket("wss://danmuproxy.douyu.com:8501/");ws.onopen=()=>{ws.send(encode({"type":"loginreq","roomid":R}));ws.send(encode({"type":"joingroup","rid":R,"gid":"-9999"}));ws.send(encode({"type":"mrkl"}));alive=setInterval(()=>{ws.send(encode({"type":"mrkl"}))},30000)};ws.onclose=close;ws.onerror=a=>{close();console.error(a)};ws.onmessage=b=>{let a=new FileReader;a.readAsArrayBuffer(b.data);a.onload=()=>{let d=new Uint8Array(a.result),c;for(let e=0,f=d.length;e<f;){c=uint(d.slice(e,e+4))+4,data=decode(d.slice(e,e+c));handle(data);e+=c}}}}function close(){clearInterval(alive);if(ws){ws.send(encode({"type":"logout"}));ws.close()}}function handle(a){if("chatmsg"==a.type&&parseInt(a.level)>=ML){player.insert({value:a.txt,opacity:0.9,fontWeight:"bold"})}};